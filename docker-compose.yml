---
version: '3.6'
services:
  validator1:
    restart: "on-failure"
    image: hyperledger/besu:${BESU_VERSION:-latest}
    environment:
      - LOG4J_CONFIGURATION_FILE=/config/log-config.xml
    entrypoint:
      - /bin/bash
      - -c
      - |
        /opt/besu/bin/besu public-key export --to=/tmp/bootnode_pubkey;
        /opt/besu/bin/besu \
        --config-file=/config/config.toml \
        --p2p-host=$$(hostname -i) \
        --genesis-file=/config/genesis.json \
        --node-private-key-file=/opt/besu/keys/key \
        --p2p-ssl-enabled \
        --p2p-ssl-keystore-type=JKS \
        --p2p-ssl-keystore-file=/opt/besu/p2p-ssl/keystore.jks \
        --p2p-ssl-keystore-password-file=/opt/besu/p2p-ssl/nsspin.txt \
        --p2p-ssl-truststore-type=JKS \
        --p2p-ssl-truststore-file=/opt/besu/p2p-ssl/truststore.jks \
        --p2p-ssl-truststore-password-file=/opt/besu/p2p-ssl/nsspin.txt \
        --rpc-http-api=EEA,WEB3,ETH,NET,PRIV,PERM,IBFT \
        --rpc-ws-api=EEA,WEB3,ETH,NET,PRIV,PERM,IBFT ;
    volumes:
      - public-keys:/tmp/
      - ./config/besu/config.toml:/config/config.toml
      - ./config/besu/log-config.xml:/config/log-config.xml
      - ./logs/besu:/tmp/besu
      - ./config/besu/ibft2Genesis.json:/config/genesis.json
      - ./config/besu/networkFiles/validator1/keys:/opt/besu/keys
      - ./config/besu/p2p-ssl/validator1:/opt/besu/p2p-ssl
      - ./config/besu/static-nodes.json:/config/static-nodes.json
  validator2:
    restart: "on-failure"
    image: hyperledger/besu:${BESU_VERSION:-latest}
    environment:
      - LOG4J_CONFIGURATION_FILE=/config/log-config.xml
    entrypoint:
      - /bin/bash
      - -c
      - |
        /opt/besu/bin/besu \
        --config-file=/config/config.toml \
        --p2p-host=$$(hostname -i) \
        --genesis-file=/config/genesis.json \
        --node-private-key-file=/opt/besu/keys/key \
        --p2p-ssl-enabled \
        --p2p-ssl-keystore-type=JKS \
        --p2p-ssl-keystore-file=/opt/besu/p2p-ssl/keystore.jks \
        --p2p-ssl-keystore-password-file=/opt/besu/p2p-ssl/nsspin.txt \
        --p2p-ssl-truststore-type=JKS \
        --p2p-ssl-truststore-file=/opt/besu/p2p-ssl/truststore.jks \
        --p2p-ssl-truststore-password-file=/opt/besu/p2p-ssl/nsspin.txt \
        --rpc-http-api=EEA,WEB3,ETH,NET,PRIV,PERM,IBFT \
        --rpc-ws-api=EEA,WEB3,ETH,NET,PRIV,PERM,IBFT ;
    volumes:
      - public-keys:/opt/besu/public-keys/
      - ./config/besu/config.toml:/config/config.toml
      - ./config/besu/log-config.xml:/config/log-config.xml
      - ./logs/besu:/tmp/besu
      - ./config/besu/ibft2Genesis.json:/config/genesis.json
      - ./config/besu/networkFiles/validator2/keys:/opt/besu/keys
      - ./config/besu/p2p-ssl/validator2:/opt/besu/p2p-ssl
      - ./config/besu/static-nodes.json:/config/static-nodes.json
    depends_on:
      - validator1
  validator3:
    restart: "on-failure"
    image: hyperledger/besu:${BESU_VERSION:-latest}
    environment:
      - LOG4J_CONFIGURATION_FILE=/config/log-config.xml
    entrypoint:
      - /bin/bash
      - -c
      - |
        /opt/besu/bin/besu \
        --config-file=/config/config.toml \
        --p2p-host=$$(hostname -i) \
        --genesis-file=/config/genesis.json \
        --node-private-key-file=/opt/besu/keys/key \
        --p2p-ssl-enabled \
        --p2p-ssl-keystore-type=JKS \
        --p2p-ssl-keystore-file=/opt/besu/p2p-ssl/keystore.jks \
        --p2p-ssl-keystore-password-file=/opt/besu/p2p-ssl/nsspin.txt \
        --p2p-ssl-truststore-type=JKS \
        --p2p-ssl-truststore-file=/opt/besu/p2p-ssl/truststore.jks \
        --p2p-ssl-truststore-password-file=/opt/besu/p2p-ssl/nsspin.txt \
        --rpc-http-api=EEA,WEB3,ETH,NET,PRIV,PERM,IBFT \
        --rpc-ws-api=EEA,WEB3,ETH,NET,PRIV,PERM,IBFT ;
    volumes:
      - public-keys:/opt/besu/public-keys/
      - ./config/besu/config.toml:/config/config.toml
      - ./config/besu/log-config.xml:/config/log-config.xml
      - ./logs/besu:/tmp/besu
      - ./config/besu/ibft2Genesis.json:/config/genesis.json
      - ./config/besu/networkFiles/validator3/keys:/opt/besu/keys
      - ./config/besu/p2p-ssl/validator3:/opt/besu/p2p-ssl
      - ./config/besu/static-nodes.json:/config/static-nodes.json
    depends_on:
      - validator1
  validator4:
    restart: "on-failure"
    image: hyperledger/besu:${BESU_VERSION:-latest}
    environment:
      - LOG4J_CONFIGURATION_FILE=/config/log-config.xml
    entrypoint:
      - /bin/bash
      - -c
      - |
        /opt/besu/bin/besu \
        --config-file=/config/config.toml \
        --p2p-host=$$(hostname -i) \
        --genesis-file=/config/genesis.json \
        --node-private-key-file=/opt/besu/keys/key \
        --p2p-ssl-enabled \
        --p2p-ssl-keystore-type=JKS \
        --p2p-ssl-keystore-file=/opt/besu/p2p-ssl/keystore.jks \
        --p2p-ssl-keystore-password-file=/opt/besu/p2p-ssl/nsspin.txt \
        --p2p-ssl-truststore-type=JKS \
        --p2p-ssl-truststore-file=/opt/besu/p2p-ssl/truststore.jks \
        --p2p-ssl-truststore-password-file=/opt/besu/p2p-ssl/nsspin.txt \
        --rpc-http-api=EEA,WEB3,ETH,NET,PRIV,PERM,IBFT \
        --rpc-ws-api=EEA,WEB3,ETH,NET,PRIV,PERM,IBFT ;
    volumes:
      - public-keys:/opt/besu/public-keys/
      - ./config/besu/config.toml:/config/config.toml
      - ./config/besu/log-config.xml:/config/log-config.xml
      - ./logs/besu:/tmp/besu
      - ./config/besu/ibft2Genesis.json:/config/genesis.json
      - ./config/besu/networkFiles/validator4/keys:/opt/besu/keys
      - ./config/besu/p2p-ssl/validator4:/opt/besu/p2p-ssl
      - ./config/besu/static-nodes.json:/config/static-nodes.json
    depends_on:
      - validator1
  rpcnode:
    restart: "on-failure"
    image: hyperledger/besu:${BESU_VERSION:-latest}
    environment:
      - LOG4J_CONFIGURATION_FILE=/config/log-config.xml
    entrypoint:
      - /bin/bash
      - -c
      - |
        /opt/besu/bin/besu \
        --config-file=/config/config.toml \
        --p2p-host=$$(hostname -i) \
        --genesis-file=/config/genesis.json \
        --node-private-key-file=/opt/besu/keys/key \
        --p2p-ssl-enabled \
        --p2p-ssl-keystore-type=JKS \
        --p2p-ssl-keystore-file=/opt/besu/p2p-ssl/keystore.jks \
        --p2p-ssl-keystore-password-file=/opt/besu/p2p-ssl/nsspin.txt \
        --p2p-ssl-truststore-type=JKS \
        --p2p-ssl-truststore-file=/opt/besu/p2p-ssl/truststore.jks \
        --p2p-ssl-truststore-password-file=/opt/besu/p2p-ssl/nsspin.txt \
        --rpc-http-api=EEA,WEB3,ETH,NET,PRIV,PERM,IBFT \
        --rpc-ws-api=EEA,WEB3,ETH,NET,PRIV,PERM,IBFT ;
    volumes:
      - public-keys:/opt/besu/public-keys/
      - ./config/besu/config.toml:/config/config.toml
      - ./config/besu/log-config.xml:/config/log-config.xml
      - ./logs/besu:/tmp/besu
      - ./config/besu/ibft2Genesis.json:/config/genesis.json
      - ./config/besu/networkFiles/rpcnode/keys:/opt/besu/keys
      - ./config/besu/p2p-ssl/rpcnode:/opt/besu/p2p-ssl
      - ./config/besu/static-nodes.json:/config/static-nodes.json
    depends_on:
      - validator1
    ports:
      - 8545:8545/tcp
      - 8546:8546/tcp
      - 8547:8547/tcp
  member1besu:
    restart: "on-failure"
    image: hyperledger/besu:${BESU_VERSION:-latest}
    environment:
      - LOG4J_CONFIGURATION_FILE=/config/log-config.xml
    entrypoint:
      - /bin/bash
      - -c
      - |
        /opt/besu/bin/besu \
        --config-file=/config/config.toml \
        --p2p-host=$$(hostname -i) \
        --genesis-file=/config/genesis.json \
        --node-private-key-file=/opt/besu/keys/key \
        --privacy-enabled \
        --privacy-onchain-groups-enabled=false \
        --privacy-public-key-file=/config/tessera/tessera.pub \
        --privacy-url=http://member1tessera:9101 \
        --p2p-ssl-enabled \
        --p2p-ssl-keystore-type=JKS \
        --p2p-ssl-keystore-file=/opt/besu/p2p-ssl/keystore.jks \
        --p2p-ssl-keystore-password-file=/opt/besu/p2p-ssl/nsspin.txt \
        --p2p-ssl-truststore-type=JKS \
        --p2p-ssl-truststore-file=/opt/besu/p2p-ssl/truststore.jks \
        --p2p-ssl-truststore-password-file=/opt/besu/p2p-ssl/nsspin.txt \
        --rpc-http-api=EEA,WEB3,ETH,NET,PRIV,PERM,IBFT \
        --rpc-ws-api=EEA,WEB3,ETH,NET,PRIV,PERM,IBFT ;
    volumes:
      - public-keys:/opt/besu/public-keys/
      - ./config/besu/config.toml:/config/config.toml
      - ./config/besu/log-config.xml:/config/log-config.xml
      - ./logs/besu:/tmp/besu
      - ./config/besu/ibft2Genesis.json:/config/genesis.json
      - ./config/besu/networkFiles/member1/keys:/opt/besu/keys
      - ./config/tessera/networkFiles/tessera1/nodeKey.pub:/config/tessera/tessera.pub
      - ./config/besu/p2p-ssl/member1besu:/opt/besu/p2p-ssl
      - ./config/besu/static-nodes.json:/config/static-nodes.json
    depends_on:
      - member1tessera
      - validator1
  member1tessera:
    image: quorumengineering/tessera:${QUORUM_TESSERA_VERSION:-21.1.1}
    restart: "no"
    healthcheck:
      test: ["CMD", "wget", "--spider", "--proxy", "off", "http://localhost:9000/upcheck"]
      interval: 3s
      timeout: 3s
      retries: 20
      start_period: 5s
    entrypoint:
      - /bin/sh
      - -c
      - |
        mkdir -p /var/log/tessera/;
        mkdir -p /data/tm/;
        cp /config/keys/tm.* /data/tm/ ;
          cat <<EOF > /data/tm/tessera-config-09.json
          {
            "mode": "orion",
            "useWhiteList": false,
            "jdbc": {
              "username": "sa",
              "password": "",
              "url": "jdbc:h2:./data/tm/db;MODE=Oracle;TRACE_LEVEL_SYSTEM_OUT=0",
              "autoCreateTables": true
            },
            "serverConfigs":[
            {
              "app":"ThirdParty",
              "enabled": true,
              "serverAddress": "http://member1tessera:9080",
              "communicationType" : "REST"
            },
            {
              "app":"Q2T",
              "enabled": true,
              "serverAddress": "http://member1tessera:9101",
              "sslConfig": {
                "tls": "OFF"
              },
              "communicationType" : "REST"
            },
            {
              "app":"P2P",
              "enabled": true,
              "serverAddress": "http://member1tessera:9000",
              "sslConfig": {
                "tls": "OFF"
              },
              "communicationType" : "REST"
            }
            ],
            "peer": [
                {
                    "url": "http://member1tessera:9000"
                },
                {
                    "url": "http://member2tessera:9000"
                },
                {
                    "url": "http://member3tessera:9000"
                }
            ],
            "keys": {
              "passwords": [],
              "keyData": [
                {
                  "config": $$(cat /data/tm/tm.key),
                  "publicKey": "$$(cat /data/tm/tm.pub)"
                }
              ]
            },
            "alwaysSendTo": []
          }
        EOF
          cat /data/tm/tessera-config-09.json
          java -Xms128M -Xmx128M -jar /tessera/tessera-app.jar --debug -configfile /data/tm/tessera-config-09.json &> /var/log/tessera/tessera-$$HOSTNAME.log | tee -a /var/log/tessera/tessera-$$HOSTNAME.log
    environment:
      - TESSERA_CONFIG_TYPE="-09"
    volumes:
      - ./config/tessera/networkFiles/tessera1:/config/keys
      - member1tessera:/data
      - ./logs/tessera:/var/log/tessera/      
  member2besu:
    restart: "on-failure"
    image: hyperledger/besu:${BESU_VERSION:-latest}
    environment:
      - LOG4J_CONFIGURATION_FILE=/config/log-config.xml
    entrypoint:
      - /bin/bash
      - -c
      - |
        /opt/besu/bin/besu \
        --config-file=/config/config.toml \
        --p2p-host=$$(hostname -i) \
        --genesis-file=/config/genesis.json \
        --node-private-key-file=/opt/besu/keys/key \
        --privacy-enabled \
        --privacy-onchain-groups-enabled=false \
        --privacy-public-key-file=/config/tessera/tessera.pub \
        --privacy-url=http://member2tessera:9101 \
        --p2p-ssl-enabled \
        --p2p-ssl-keystore-type=JKS \
        --p2p-ssl-keystore-file=/opt/besu/p2p-ssl/keystore.jks \
        --p2p-ssl-keystore-password-file=/opt/besu/p2p-ssl/nsspin.txt \
        --p2p-ssl-truststore-type=JKS \
        --p2p-ssl-truststore-file=/opt/besu/p2p-ssl/truststore.jks \
        --p2p-ssl-truststore-password-file=/opt/besu/p2p-ssl/nsspin.txt \
        --rpc-http-api=EEA,WEB3,ETH,NET,PRIV,PERM,IBFT \
        --rpc-ws-api=EEA,WEB3,ETH,NET,PRIV,PERM,IBFT ;
    volumes:
      - public-keys:/opt/besu/public-keys/
      - ./config/besu/config.toml:/config/config.toml
      - ./config/besu/log-config.xml:/config/log-config.xml
      - ./logs/besu:/tmp/besu
      - ./config/besu/ibft2Genesis.json:/config/genesis.json
      - ./config/besu/networkFiles/member2/keys:/opt/besu/keys
      - ./config/tessera/networkFiles/tessera2/nodeKey.pub:/config/tessera/tessera.pub
      - ./config/besu/p2p-ssl/member2besu:/opt/besu/p2p-ssl
      - ./config/besu/static-nodes.json:/config/static-nodes.json
    depends_on:
      - member2tessera
      - validator1
  member2tessera:
    image: quorumengineering/tessera:${QUORUM_TESSERA_VERSION:-21.1.1}
    restart: "no"
    healthcheck:
      test: ["CMD", "wget", "--spider", "--proxy", "off", "http://localhost:9000/upcheck"]
      interval: 3s
      timeout: 3s
      retries: 20
      start_period: 5s
    entrypoint:
      - /bin/sh
      - -c
      - |
        mkdir -p /var/log/tessera/;
        mkdir -p /data/tm/;
        cp /config/keys/tm.* /data/tm/ ;
          cat <<EOF > /data/tm/tessera-config-09.json
          {
            "mode": "orion",
            "useWhiteList": false,
            "jdbc": {
              "username": "sa",
              "password": "",
              "url": "jdbc:h2:./data/tm/db;MODE=Oracle;TRACE_LEVEL_SYSTEM_OUT=0",
              "autoCreateTables": true
            },
            "serverConfigs":[
            {
              "app":"ThirdParty",
              "enabled": true,
              "serverAddress": "http://member2tessera:9080",
              "communicationType" : "REST"
            },
            {
              "app":"Q2T",
              "enabled": true,
              "serverAddress": "http://member2tessera:9101",
              "sslConfig": {
                "tls": "OFF"
              },
              "communicationType" : "REST"
            },
            {
              "app":"P2P",
              "enabled": true,
              "serverAddress": "http://member2tessera:9000",
              "sslConfig": {
                "tls": "OFF"
              },
              "communicationType" : "REST"
            }
            ],
            "peer": [
                {
                    "url": "http://member1tessera:9000"
                },
                {
                    "url": "http://member2tessera:9000"
                },
                {
                    "url": "http://member3tessera:9000"
                }
            ],
            "keys": {
              "passwords": [],
              "keyData": [
                {
                  "config": $$(cat /data/tm/tm.key),
                  "publicKey": "$$(cat /data/tm/tm.pub)"
                }
              ]
            },
            "alwaysSendTo": []
          }
        EOF
          cat /data/tm/tessera-config-09.json
          java -Xms128M -Xmx128M -jar /tessera/tessera-app.jar --debug -configfile /data/tm/tessera-config-09.json &> /var/log/tessera/tessera-$$HOSTNAME.log | tee -a /var/log/tessera/tessera-$$HOSTNAME.log
    environment:
      - TESSERA_CONFIG_TYPE="-09"
    volumes:
      - ./config/tessera/networkFiles/tessera2:/config/keys
      - member2tessera:/data
      - ./logs/tessera:/var/log/tessera/      
  member3besu:
    restart: "on-failure"
    image: hyperledger/besu:${BESU_VERSION:-latest}
    environment:
      - LOG4J_CONFIGURATION_FILE=/config/log-config.xml
    entrypoint:
      - /bin/bash
      - -c
      - |
        /opt/besu/bin/besu \
        --config-file=/config/config.toml \
        --p2p-host=$$(hostname -i) \
        --genesis-file=/config/genesis.json \
        --node-private-key-file=/opt/besu/keys/key \
        --privacy-enabled \
        --privacy-onchain-groups-enabled=false \
        --privacy-public-key-file=/config/tessera/tessera.pub \
        --privacy-url=http://member3tessera:9101 \
        --p2p-ssl-enabled \
        --p2p-ssl-keystore-type=JKS \
        --p2p-ssl-keystore-file=/opt/besu/p2p-ssl/keystore.jks \
        --p2p-ssl-keystore-password-file=/opt/besu/p2p-ssl/nsspin.txt \
        --p2p-ssl-truststore-type=JKS \
        --p2p-ssl-truststore-file=/opt/besu/p2p-ssl/truststore.jks \
        --p2p-ssl-truststore-password-file=/opt/besu/p2p-ssl/nsspin.txt \
        --rpc-http-api=EEA,WEB3,ETH,NET,PRIV,PERM,IBFT \
        --rpc-ws-api=EEA,WEB3,ETH,NET,PRIV,PERM,IBFT ;
    volumes:
      - public-keys:/opt/besu/public-keys/
      - ./config/besu/config.toml:/config/config.toml
      - ./config/besu/log-config.xml:/config/log-config.xml
      - ./logs/besu:/tmp/besu
      - ./config/besu/ibft2Genesis.json:/config/genesis.json
      - ./config/besu/networkFiles/member3/keys:/opt/besu/keys
      - ./config/tessera/networkFiles/tessera3/nodeKey.pub:/config/tessera/tessera.pub
      - ./config/besu/p2p-ssl/member3besu:/opt/besu/p2p-ssl
      - ./config/besu/static-nodes.json:/config/static-nodes.json
    depends_on:
      - member3tessera
      - validator1
  member3tessera:
    image: quorumengineering/tessera:${QUORUM_TESSERA_VERSION:-21.1.1}
    restart: "no"
    healthcheck:
      test: ["CMD", "wget", "--spider", "--proxy", "off", "http://localhost:9000/upcheck"]
      interval: 3s
      timeout: 3s
      retries: 20
      start_period: 5s
    entrypoint:
      - /bin/sh
      - -c
      - |
        mkdir -p /var/log/tessera/;
        mkdir -p /data/tm/;
        cp /config/keys/tm.* /data/tm/ ;
          cat <<EOF > /data/tm/tessera-config-09.json
          {
            "mode": "orion",
            "useWhiteList": false,
            "jdbc": {
              "username": "sa",
              "password": "",
              "url": "jdbc:h2:./data/tm/db;MODE=Oracle;TRACE_LEVEL_SYSTEM_OUT=0",
              "autoCreateTables": true
            },
            "serverConfigs":[
            {
              "app":"ThirdParty",
              "enabled": true,
              "serverAddress": "http://member3tessera:9080",
              "communicationType" : "REST"
            },
            {
              "app":"Q2T",
              "enabled": true,
              "serverAddress": "http://member3tessera:9101",
              "sslConfig": {
                "tls": "OFF"
              },
              "communicationType" : "REST"
            },
            {
              "app":"P2P",
              "enabled": true,
              "serverAddress": "http://member3tessera:9000",
              "sslConfig": {
                "tls": "OFF"
              },
              "communicationType" : "REST"
            }
            ],
            "peer": [
                {
                    "url": "http://member1tessera:9000"
                },
                {
                    "url": "http://member2tessera:9000"
                },
                {
                    "url": "http://member3tessera:9000"
                }
            ],
            "keys": {
              "passwords": [],
              "keyData": [
                {
                  "config": $$(cat /data/tm/tm.key),
                  "publicKey": "$$(cat /data/tm/tm.pub)"
                }
              ]
            },
            "alwaysSendTo": []
          }
        EOF
          cat /data/tm/tessera-config-09.json
          java -Xms128M -Xmx128M -jar /tessera/tessera-app.jar --debug -configfile /data/tm/tessera-config-09.json &> /var/log/tessera/tessera-$$HOSTNAME.log | tee -a /var/log/tessera/tessera-$$HOSTNAME.log
    environment:
      - TESSERA_CONFIG_TYPE="-09"
    volumes:
      - ./config/tessera/networkFiles/tessera3:/config/keys
      - member3tessera:/data
      - ./logs/tessera:/var/log/tessera/      
  explorer:
    build: block-explorer-light/.
    image: quorum-dev-quickstart/block-explorer-light:develop
    depends_on:
      - rpcnode
    ports:
      - 25000:80/tcp
volumes:
  public-keys:
  prometheus:
  grafana:
  cakeshop:
  member1tessera:
  member2tessera:
  member3tessera:
